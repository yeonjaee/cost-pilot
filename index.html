<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 모델 API 비용 계산기 (v6.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Token counting libraries -->
    <script src="https://unpkg.com/@dqbd/tiktoken@1.0.0/dist/tiktoken.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-tiktoken@1.0.0/dist/tiktoken.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .focus-style:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
            border-color: #3B82F6;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        /* Custom styles for range slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 9999px;
            outline: none;
            opacity: 0.9;
            transition: opacity .15s ease-in-out;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3B82F6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3B82F6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .info-tooltip {
            position: relative;
            display: inline-block;
        }
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
        }
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .scenario-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .scenario-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .scenario-card.selected {
            border-color: #3B82F6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="w-full max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">LLM AI 비용 계산기</h1>
            <p class="text-gray-600 text-lg">캐릭터 챗봇 운영 비용을 정확하게 예측하고 최적화하세요</p>
        </div>

        <!-- Help Section -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-blue-800 mb-4">💡 이 도구가 필요한 이유</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-700">
                <div>
                    <h3 class="font-semibold mb-2">🎯 정확한 비용 예측</h3>
                    <p>실제 캐릭터 챗봇 사용 패턴을 반영하여 월 운영비를 미리 계산할 수 있습니다.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">📊 모델별 비교</h3>
                    <p>다양한 AI 모델의 성능과 비용을 비교하여 최적의 선택을 할 수 있습니다.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">⚡ 컨텍스트 최적화</h3>
                    <p>대화 기억 용량을 조절하여 비용을 절약하면서도 품질을 유지할 수 있습니다.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">🔍 벡터 검색 비용</h3>
                    <p>로어북(문서 검색) 기능 사용 시 추가되는 비용도 정확히 계산됩니다.</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Settings -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Scenario Selection -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">1. 사용 시나리오 선택</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="scenario-card p-4 border-2 border-gray-200 rounded-lg" data-scenario="casual">
                            <h3 class="font-bold text-gray-800 mb-2">💬 일반 대화</h3>
                            <p class="text-sm text-gray-600 mb-2">일상적인 대화와 질문응답</p>
                            <div class="text-xs text-gray-500">
                                <p>• 입력: 20-50 토큰</p>
                                <p>• 출력: 100-300 토큰</p>
                                <p>• 로어북: 사용 안함</p>
                            </div>
                        </div>
                        <div class="scenario-card p-4 border-2 border-gray-200 rounded-lg" data-scenario="story">
                            <h3 class="font-bold text-gray-800 mb-2">📚 스토리텔링</h3>
                            <p class="text-sm text-gray-600 mb-2">긴 이야기 생성과 역할극</p>
                            <div class="text-xs text-gray-500">
                                <p>• 입력: 50-150 토큰</p>
                                <p>• 출력: 300-800 토큰</p>
                                <p>• 로어북: 가끔 사용</p>
                            </div>
                        </div>
                        <div class="scenario-card p-4 border-2 border-gray-200 rounded-lg" data-scenario="roleplay">
                            <h3 class="font-bold text-gray-800 mb-2">🎭 역할극</h3>
                            <p class="text-sm text-gray-600 mb-2">캐릭터 역할극과 상세한 상호작용</p>
                            <div class="text-xs text-gray-500">
                                <p>• 입력: 100-200 토큰</p>
                                <p>• 출력: 200-500 토큰</p>
                                <p>• 로어북: 자주 사용</p>
                            </div>
                        </div>
                        <div class="scenario-card p-4 border-2 border-gray-200 rounded-lg" data-scenario="custom">
                            <h3 class="font-bold text-gray-800 mb-2">⚙️ 사용자 정의</h3>
                            <p class="text-sm text-gray-600 mb-2">직접 설정하여 정확한 계산</p>
                            <div class="text-xs text-gray-500">
                                <p>• 입력: 직접 설정</p>
                                <p>• 출력: 직접 설정</p>
                                <p>• 로어북: 선택 가능</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Model and Context Settings -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">2. 모델 및 설정</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="model-select" class="block text-sm font-medium text-gray-700 mb-2">
                                AI 모델 선택
                                <span class="info-tooltip ml-1">
                                    <span class="text-blue-500">ℹ️</span>
                                    <span class="tooltip-text">
                                        <strong>Claude Sonnet 4.5:</strong> 가장 고품질, 비용 높음<br>
                                        <strong>Gemini 2.5 Pro:</strong> 균형잡힌 성능과 비용<br>
                                        <strong>Gemini 2.5 Flash:</strong> 빠르고 저렴<br>
                                        <strong>Grok 4 Fast:</strong> 매우 저렴, 최신 모델<br>
                                        <strong>Gemini Flash Lite:</strong> 가장 저렴
                                    </span>
                                </span>
                            </label>
                            <select id="model-select" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus-style">
                                <option value="claude-4.5-sonnet">Claude Sonnet 4.5 (200K)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro (1M)</option>
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash (1M)</option>
                                <option value="grok-4-fast">Grok 4 Fast (2M)</option>
                                <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite (1M)</option>
                            </select>
                        </div>

                        <div>
                            <label for="context-limit-select" class="block text-sm font-medium text-gray-700 mb-2">
                                컨텍스트 사용량 제한
                                <span class="info-tooltip ml-1">
                                    <span class="text-blue-500">ℹ️</span>
                                    <span class="tooltip-text">
                                        <strong>컨텍스트:</strong> AI가 기억하는 대화 내용의 양<br>
                                        <strong>높을수록:</strong> 더 긴 대화 기억, 비용 증가<br>
                                        <strong>낮을수록:</strong> 짧은 기억, 비용 절약<br>
                                        <strong>권장:</strong> 60-80% (품질과 비용의 균형)
                                    </span>
                                </span>
                            </label>
                            <select id="context-limit-select" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus-style">
                                <option value="0.1">모델 최대치의 10%</option>
                                <option value="0.2">모델 최대치의 20%</option>
                                <option value="0.3">모델 최대치의 30%</option>
                                <option value="0.4">모델 최대치의 40%</option>
                                <option value="0.5">모델 최대치의 50%</option>
                                <option value="0.6">모델 최대치의 60%</option>
                                <option value="0.7">모델 최대치의 70%</option>
                                <option value="0.8" selected>모델 최대치의 80%</option>
                                <option value="0.9">모델 최대치의 90%</option>
                                <option value="1.0">모델 최대치의 100%</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- System Prompt -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">3. 시스템 프롬프트 설정</h2>
                    <div>
                        <label for="system-prompt" class="block text-sm font-medium text-gray-700 mb-2">
                            시스템 프롬프트 (캐릭터 설정)
                            <span class="info-tooltip ml-1">
                                <span class="text-blue-500">ℹ️</span>
                                <span class="tooltip-text">
                                    <strong>시스템 프롬프트:</strong> AI의 성격과 역할을 정의하는 지시사항<br>
                                    <strong>예시:</strong> "당신은 친근한 고양이 캐릭터입니다. 항상 귀엽게 말하고 '냥'을 자주 사용하세요."<br>
                                    <strong>토큰:</strong> 입력한 텍스트가 실제로 몇 개의 토큰으로 계산되는지 표시됩니다.
                                </span>
                            </span>
                        </label>
                        <textarea id="system-prompt" rows="4" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus-style" placeholder="예시: 당신은 친근한 고양이 캐릭터입니다. 항상 귀엽게 말하고 '냥'을 자주 사용하세요. 사용자와 함께 놀고 싶어합니다.">당신은 친근한 고양이 캐릭터입니다. 항상 귀엽게 말하고 '냥'을 자주 사용하세요. 사용자와 함께 놀고 싶어합니다.</textarea>
                        <div class="mt-2 text-sm text-gray-600">
                            <span>실제 토큰 수: </span>
                            <span id="system-token-count" class="font-bold text-blue-600">0</span>
                            <span> 토큰</span>
                            <span class="info-tooltip ml-1">
                                <span class="text-blue-500">ℹ️</span>
                                <span class="tooltip-text">
                                    <strong>토큰 계산 방식:</strong><br>
                                    • <strong>tiktoken 라이브러리</strong> 사용 (가능한 경우)<br>
                                    • <strong>모델별 최적화</strong>: Claude/GPT는 정확한 토큰화<br>
                                    • <strong>폴백 방식</strong>: 한국어 1글자≈1토큰<br><br>
                                    <strong>참고:</strong> tiktoken이 로드되지 않으면 근사치를 사용합니다.
                                </span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Token Settings -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">4. 토큰 설정</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="input-slider" class="block text-sm font-medium text-gray-700 mb-2">
                                예상 입력 길이 (토큰): 
                                <span id="input-slider-value" class="font-bold text-blue-600">50</span>
                                <span class="info-tooltip ml-1">
                                    <span class="text-blue-500">ℹ️</span>
                                    <span class="tooltip-text">
                                        <strong>입력 토큰:</strong> 사용자가 보내는 메시지의 길이<br>
                                        <strong>예시:</strong><br>
                                        • "안녕" = 약 2 토큰<br>
                                        • "오늘 날씨가 어때?" = 약 8 토큰<br>
                                        • "좀 더 자세히 설명해줘" = 약 10 토큰
                                    </span>
                                </span>
                            </label>
                            <input type="range" id="input-slider" min="0" max="5000" value="50" step="50" class="w-full">
                        </div>

                        <div>
                            <label for="output-slider" class="block text-sm font-medium text-gray-700 mb-2">
                                예상 출력 길이 (토큰): 
                                <span id="output-slider-value" class="font-bold text-blue-600">800</span>
                                <span class="info-tooltip ml-1">
                                    <span class="text-blue-500">ℹ️</span>
                                    <span class="tooltip-text">
                                        <strong>출력 토큰:</strong> AI가 생성하는 응답의 길이<br>
                                        <strong>예시:</strong><br>
                                        • 짧은 답변 = 50-100 토큰<br>
                                        • 일반적인 답변 = 200-500 토큰<br>
                                        • 긴 스토리 = 500-2000 토큰
                                    </span>
                                </span>
                            </label>
                            <input type="range" id="output-slider" min="0" max="5000" value="800" step="50" class="w-full">
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            로어북 (벡터 검색) 사용
                            <span class="info-tooltip ml-1">
                                <span class="text-blue-500">ℹ️</span>
                                <span class="tooltip-text">
                                    <strong>로어북:</strong> AI가 참조할 수 있는 추가 문서나 정보<br>
                                    <strong>사용 예시:</strong> 캐릭터 설정, 세계관 정보, 이벤트 스크립트 등<br>
                                    <strong>비용:</strong> 문서 검색을 위한 추가 비용이 발생합니다
                                </span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-100">
                            <input type="checkbox" id="use-lorebook" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                            <span class="ml-3 text-sm text-gray-800">문서(500토큰) 검색 비용 추가</span>
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-4">
                    <button id="add-turn-btn" class="flex-1 py-3 px-4 bg-blue-600 text-white font-bold rounded-lg btn shadow-md">대화 턴 추가</button>
                    <button id="reset-btn" class="flex-1 py-3 px-4 bg-gray-600 text-white font-bold rounded-lg btn shadow-md">대화 초기화</button>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="space-y-6">
                <!-- Next Call Cost -->
                <div class="p-6 bg-green-50 rounded-xl border border-green-200 shadow-lg">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">다음 호출 비용 예측</h3>
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-md font-semibold text-gray-700">예상 비용</p>
                        <p id="preview-cost" class="text-2xl font-bold text-green-700">0.00 원</p>
                    </div>
                    <div class="text-sm text-gray-600 space-y-1 border-t border-green-200 pt-3">
                        <p>• 시스템 프롬프트: <span id="preview-system-token" class="font-semibold"></span></p>
                        <p>• 적용 컨텍스트 (기억 용량): <span id="preview-context-token" class="font-semibold"></span></p>
                        <p id="preview-lorebook-p" class="hidden text-purple-700">• 로어북 문서 (벡터 검색): <span id="preview-lorebook-token" class="font-semibold"></span></p>
                        <p>• 사용자 입력: <span id="preview-user-input-token" class="font-semibold"></span></p>
                        <p class="font-bold text-blue-700 mt-1">→ 총 입력 (Input): <span id="preview-total-input-token"></span></p>
                        <p class="font-bold text-green-800">→ 총 출력 (Output): <span id="preview-output-token"></span></p>
                    </div>
                </div>

                <!-- Conversation Summary -->
                <div class="p-6 bg-blue-50 rounded-xl border border-blue-200 shadow-lg">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">대화 요약</h3>
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-md font-semibold text-gray-700">총 누적 비용</p>
                        <p id="summary-total-cost" class="text-2xl font-bold text-blue-800">0.00 원</p>
                    </div>
                    <div class="text-sm text-gray-600 space-y-1 border-t border-blue-200 pt-3">
                        <p>• 총 누적 기억 용량: <span id="summary-context-token" class="font-semibold">0</span> 토큰</p>
                        <p>• 총 대화 턴 수: <span id="summary-turn-count" class="font-semibold">0</span> 회</p>
                    </div>
                    <div class="mt-4">
                        <label class="block text-xs font-medium text-gray-500 mb-1">대화 기록</label>
                        <div id="history-log" class="h-20 p-2 bg-white border rounded-md overflow-y-auto text-xs text-gray-500">
                            <p>아직 대화 기록이 없습니다.</p>
                        </div>
                    </div>
                </div>

                <!-- Monthly Estimate -->
                <div class="p-6 bg-purple-50 rounded-xl border border-purple-200 shadow-lg">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">월간 비용 추정</h3>
                    <div class="space-y-4">
                        <!-- User count input -->
                        <div>
                            <label for="user-count" class="block text-sm font-medium text-gray-700 mb-2">
                                총 사용자 수
                                <span class="info-tooltip ml-1">
                                    <span class="text-blue-500">ℹ️</span>
                                    <span class="tooltip-text">
                                        <strong>사용자 수:</strong> 서비스를 이용할 전체 사용자 수<br>
                                        <strong>예시:</strong> 100명의 사용자가 챗봇을 사용하는 경우
                                    </span>
                                </span>
                            </label>
                            <input type="number" id="user-count" value="1" min="1" max="1000000" 
                                   class="w-full p-2 text-sm border border-gray-300 rounded-lg focus-style text-center font-semibold">
                        </div>

                        <!-- Daily turns per user -->
                        <div>
                            <label for="daily-turns" class="block text-sm font-medium text-gray-700 mb-2">
                                1인당 일일 대화 턴 수
                                <span class="info-tooltip ml-1">
                                    <span class="text-blue-500">ℹ️</span>
                                    <span class="tooltip-text">
                                        <strong>대화 턴:</strong> 사용자가 메시지를 보내고 AI가 응답하는 것을 1턴으로 계산<br>
                                        <strong>예시:</strong><br>
                                        • 가벼운 사용: 10-30턴/일<br>
                                        • 일반적 사용: 50-100턴/일<br>
                                        • 적극적 사용: 200-500턴/일
                                    </span>
                                </span>
                            </label>
                            <input type="number" id="daily-turns" value="100" min="1" max="10000" 
                                   class="w-full p-2 text-sm border border-gray-300 rounded-lg focus-style text-center font-semibold">
                        </div>

                        <!-- Cost breakdown -->
                        <div class="border-t border-purple-200 pt-4 space-y-3">
                            <div class="bg-white rounded-lg p-3">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs text-gray-600">1인당 1턴 비용:</span>
                                    <span id="per-turn-cost" class="font-semibold text-purple-700">0원</span>
                                </div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs text-gray-600">1인당 일일 비용:</span>
                                    <span id="per-user-daily-cost" class="font-semibold text-purple-700">0원</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-600">전체 일일 비용:</span>
                                    <span id="total-daily-cost" class="font-semibold text-purple-800">0원</span>
                                </div>
                            </div>

                            <div class="bg-purple-100 rounded-lg p-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-bold text-gray-800">월간 총 비용 (30일):</span>
                                    <span id="monthly-cost" class="font-bold text-purple-900 text-xl">0원</span>
                                </div>
                            </div>
                        </div>

                        <div class="text-xs text-gray-500 bg-white rounded p-3">
                            <p class="font-semibold mb-1">💡 계산 방식:</p>
                            <p>• <strong>1턴 비용:</strong> 다음 호출 시 예상 비용 (현재 컨텍스트 기준)</p>
                            <p>• <strong>일일 비용:</strong> 평균 턴 비용 × 일일 턴 수 (컨텍스트 누적 고려)</p>
                            <p>• <strong>월간 비용:</strong> 일일 비용 × 사용자 수 × 30일</p>
                            <p class="mt-2 text-gray-400">※ 컨텍스트가 누적되면서 비용이 점진적으로 증가하는 것을 반영합니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const modelPrices = {
            'claude-4.5-sonnet':      { input: 3.00,  output: 15.00, context: 200000 },
            'gemini-2.5-pro':         { input: 1.25,  output: 10.00, context: 1048576 },
            'gemini-2.5-flash':       { input: 0.30,  output: 2.50,  context: 1000000 },
            'grok-4-fast':            { input: 0.20,  output: 0.50,  context: 2000000 },
            'gemini-2.5-flash-lite':  { input: 0.10,  output: 0.40,  context: 1048576 }
        };
        const retrievalPrices = {
            'embedding': { cost: 0.10 },
            'ranking': { cost: 0.0 } 
        };
        const USD_TO_KRW = 1392;
        const LOREBOOK_DOCUMENT_TOKENS = 500;

        // Scenario presets
        const scenarioPresets = {
            'casual': { input: 30, output: 200, lorebook: false },
            'story': { input: 100, output: 600, lorebook: true },
            'roleplay': { input: 150, output: 400, lorebook: true },
            'custom': { input: 50, output: 800, lorebook: false }
        };

        // --- STATE ---
        let conversationHistory = [];
        let totalCostKRW = 0;
        let currentScenario = 'casual';

        // --- DOM ELEMENTS ---
        const dom = {
            modelSelect: document.getElementById('model-select'),
            contextLimitSelect: document.getElementById('context-limit-select'),
            systemPrompt: document.getElementById('system-prompt'),
            systemTokenCount: document.getElementById('system-token-count'),
            inputSlider: document.getElementById('input-slider'),
            inputSliderValue: document.getElementById('input-slider-value'),
            outputSlider: document.getElementById('output-slider'),
            outputSliderValue: document.getElementById('output-slider-value'),
            useLorebookCheckbox: document.getElementById('use-lorebook'),
            addTurnBtn: document.getElementById('add-turn-btn'),
            resetBtn: document.getElementById('reset-btn'),
            dailyTurns: document.getElementById('daily-turns'),
            
            preview: {
                cost: document.getElementById('preview-cost'),
                systemToken: document.getElementById('preview-system-token'),
                contextToken: document.getElementById('preview-context-token'),
                lorebookP: document.getElementById('preview-lorebook-p'),
                lorebookToken: document.getElementById('preview-lorebook-token'),
                userInputToken: document.getElementById('preview-user-input-token'),
                totalInputToken: document.getElementById('preview-total-input-token'),
                outputToken: document.getElementById('preview-output-token'),
            },
            
            summary: {
                totalCost: document.getElementById('summary-total-cost'),
                contextToken: document.getElementById('summary-context-token'),
                turnCount: document.getElementById('summary-turn-count'),
                historyLog: document.getElementById('history-log'),
            },
            
            monthly: {
                cost: document.getElementById('monthly-cost')
            },
            
            costBreakdown: {
                perTurnCost: document.getElementById('per-turn-cost'),
                perUserDailyCost: document.getElementById('per-user-daily-cost'),
                totalDailyCost: document.getElementById('total-daily-cost')
            }
        };

        // --- UTILITY FUNCTIONS ---
        const formatNumber = (num) => num.toLocaleString('ko-KR');
        const formatKRW = (num) => num.toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // Token estimation with multiple methods
        function estimateTokens(text) {
            if (!text) return 0;
            
            // Try to use tiktoken if available
            if (typeof tiktoken !== 'undefined') {
                try {
                    const encoding = tiktoken.get_encoding("cl100k_base");
                    return encoding.encode(text).length;
                } catch (e) {
                    console.log("tiktoken not available, using fallback");
                }
            }
            
            // Fallback: Multiple estimation methods
            const koreanChars = (text.match(/[가-힣]/g) || []).length;
            const englishWords = (text.match(/[a-zA-Z]+/g) || []).length;
            const otherChars = text.length - koreanChars - (text.match(/[a-zA-Z]+/g) || []).join('').length;
            const simpleEstimate = Math.ceil(koreanChars + (englishWords * 1.3) + (otherChars * 0.5));
            
            const charBasedEstimate = Math.ceil(text.length * 0.75);
            const words = text.split(/\s+/).filter(word => word.length > 0);
            const wordBasedEstimate = Math.ceil(words.length * 1.3);
            
            return Math.max(simpleEstimate, charBasedEstimate, wordBasedEstimate);
        }

        // Model-specific token counting
        function estimateTokensByModel(text, model) {
            if (!text) return 0;
            
            // Try tiktoken for OpenAI models
            if (model.includes('gpt') || model.includes('claude')) {
                if (typeof tiktoken !== 'undefined') {
                    try {
                        const encoding = tiktoken.get_encoding("cl100k_base");
                        return encoding.encode(text).length;
                    } catch (e) {
                        console.log("tiktoken failed, using fallback");
                    }
                }
            }
            
            // Fallback to general estimation
            return estimateTokens(text);
        }

        // More accurate token counting using tiktoken-like approach
        function estimateTokensAdvanced(text) {
            if (!text) return 0;
            
            // This is a simplified version of how tiktoken works
            let tokens = 0;
            let i = 0;
            
            while (i < text.length) {
                const char = text[i];
                
                // Korean characters (most common case)
                if (/[가-힣]/.test(char)) {
                    tokens += 1;
                }
                // English letters
                else if (/[a-zA-Z]/.test(char)) {
                    // Count consecutive letters as one token
                    let wordLength = 0;
                    while (i < text.length && /[a-zA-Z]/.test(text[i])) {
                        wordLength++;
                        i++;
                    }
                    i--; // Adjust for the loop increment
                    tokens += Math.ceil(wordLength / 4); // Roughly 4 characters per token
                }
                // Numbers
                else if (/[0-9]/.test(char)) {
                    let numLength = 0;
                    while (i < text.length && /[0-9]/.test(text[i])) {
                        numLength++;
                        i++;
                    }
                    i--; // Adjust for the loop increment
                    tokens += Math.ceil(numLength / 3); // Roughly 3 digits per token
                }
                // Punctuation and spaces
                else {
                    tokens += 1;
                }
                
                i++;
            }
            
            return tokens;
        }

        function getSelectedValues() {
            const model = dom.modelSelect.value;
            const modelInfo = modelPrices[model];
            const contextLimit = parseFloat(dom.contextLimitSelect.value);
            const maxWindow = modelInfo.context * contextLimit;
            const systemTokens = estimateTokensByModel(dom.systemPrompt.value, model);
            
            return {
                model: model,
                maxWindow: maxWindow,
                systemTokens: systemTokens,
                inputTokens: parseInt(dom.inputSlider.value, 10),
                outputTokens: parseInt(dom.outputSlider.value, 10),
                useLorebook: dom.useLorebookCheckbox.checked,
            };
        }

        function calculateEffectiveContext(maxWindow) {
            let effectiveContext = 0;
            for (let i = conversationHistory.length - 1; i >= 0; i--) {
                const turnTokens = conversationHistory[i].input + conversationHistory[i].output;
                if (effectiveContext + turnTokens > maxWindow) {
                    break;
                }
                effectiveContext += turnTokens;
            }
            return effectiveContext;
        }

        function previewCost() {
            const { model, maxWindow, systemTokens, inputTokens, outputTokens, useLorebook } = getSelectedValues();
            const effectiveContext = calculateEffectiveContext(maxWindow);
            
            let lorebookTokens = 0;
            let retrievalCostKRW = 0;

            if (useLorebook) {
                lorebookTokens = LOREBOOK_DOCUMENT_TOKENS;
                const retrievalCostUSD = (lorebookTokens / 1_000_000) * (retrievalPrices.embedding.cost + retrievalPrices.ranking.cost);
                retrievalCostKRW = retrievalCostUSD * USD_TO_KRW;
            }

            const totalInputTokens = systemTokens + effectiveContext + inputTokens + lorebookTokens;

            const prices = modelPrices[model];
            const inputCostUSD = (totalInputTokens / 1_000_000) * prices.input;
            const outputCostUSD = (outputTokens / 1_000_000) * prices.output;
            const llmCostKRW = (inputCostUSD + outputCostUSD) * USD_TO_KRW;
            
            const turnCostKRW = llmCostKRW + retrievalCostKRW;

            // Update Preview UI
            dom.preview.cost.textContent = `${formatKRW(turnCostKRW)} 원`;
            dom.preview.systemToken.textContent = `${formatNumber(systemTokens)}`;
            dom.preview.contextToken.textContent = `${formatNumber(effectiveContext)} / ${formatNumber(Math.floor(maxWindow))}`;
            dom.preview.userInputToken.textContent = formatNumber(inputTokens);
            dom.preview.totalInputToken.textContent = formatNumber(totalInputTokens);
            dom.preview.outputToken.textContent = formatNumber(outputTokens);

            if (useLorebook) {
                dom.preview.lorebookToken.textContent = formatNumber(lorebookTokens);
                dom.preview.lorebookP.classList.remove('hidden');
            } else {
                dom.preview.lorebookP.classList.add('hidden');
            }

            // Update monthly estimate
            updateMonthlyEstimate(turnCostKRW);
        }

        function updateMonthlyEstimate(turnCostKRW) {
            const dailyTurns = parseInt(dom.dailyTurns.value) || 100;
            const userCount = parseInt(document.getElementById('user-count').value) || 1;
            
            // 현재 턴 비용 (다음 호출 비용)
            dom.costBreakdown.perTurnCost.textContent = `${formatKRW(turnCostKRW)}원`;
            
            // 일일 비용 계산 - 평균 비용 방식 사용
            const averageTurnCost = calculateAverageTurnCost(dailyTurns);
            const perUserDailyCost = averageTurnCost * dailyTurns;
            const totalDailyCost = perUserDailyCost * userCount;
            const monthlyCost = totalDailyCost * 30;
            
            // 비용 분석 업데이트
            dom.costBreakdown.perUserDailyCost.textContent = `${formatKRW(perUserDailyCost)}원`;
            dom.costBreakdown.totalDailyCost.textContent = `${formatKRW(totalDailyCost)}원`;
            
            // 월간 비용 업데이트
            dom.monthly.cost.textContent = `${formatKRW(monthlyCost)}원`;
        }

        function calculateAverageTurnCost(dailyTurns) {
            const { model, maxWindow, systemTokens, inputTokens, outputTokens, useLorebook } = getSelectedValues();
            const prices = modelPrices[model];
            
            let lorebookTokens = 0;
            let retrievalCostKRW = 0;
            
            if (useLorebook) {
                lorebookTokens = LOREBOOK_DOCUMENT_TOKENS;
                const retrievalCostUSD = (lorebookTokens / 1_000_000) * (retrievalPrices.embedding.cost + retrievalPrices.ranking.cost);
                retrievalCostKRW = retrievalCostUSD * USD_TO_KRW;
            }
            
            // 일일 턴 수에 따른 평균 컨텍스트 크기 계산
            const averageContextPerTurn = Math.min(maxWindow / 2, (inputTokens + outputTokens) * dailyTurns / 2);
            const averageContextTokens = Math.min(averageContextPerTurn, maxWindow);
            
            const totalInputTokens = systemTokens + averageContextTokens + inputTokens + lorebookTokens;
            
            const inputCostUSD = (totalInputTokens / 1_000_000) * prices.input;
            const outputCostUSD = (outputTokens / 1_000_000) * prices.output;
            const llmCostKRW = (inputCostUSD + outputCostUSD) * USD_TO_KRW;
            
            return llmCostKRW + retrievalCostKRW;
        }

        function handleAddTurn() {
            const { model, maxWindow, systemTokens, inputTokens, outputTokens, useLorebook } = getSelectedValues();
            const effectiveContext = calculateEffectiveContext(maxWindow);
            
            let lorebookTokens = 0;
            let retrievalCostKRW = 0;

            if (useLorebook) {
                lorebookTokens = LOREBOOK_DOCUMENT_TOKENS;
                const retrievalCostUSD = (lorebookTokens / 1_000_000) * (retrievalPrices.embedding.cost + retrievalPrices.ranking.cost);
                retrievalCostKRW = retrievalCostUSD * USD_TO_KRW;
            }
            
            const totalInputTokens = systemTokens + effectiveContext + inputTokens + lorebookTokens;
            
            const prices = modelPrices[model];
            const inputCostUSD = (totalInputTokens / 1_000_000) * prices.input;
            const outputCostUSD = (outputTokens / 1_000_000) * prices.output;
            const llmCostKRW = (inputCostUSD + outputCostUSD) * USD_TO_KRW;
            
            const turnCostKRW = llmCostKRW + retrievalCostKRW;

            // Update state
            totalCostKRW += turnCostKRW;
            const newTurn = { 
                turn: conversationHistory.length + 1, 
                input: inputTokens, 
                output: outputTokens,
                usedLorebook: useLorebook 
            };
            conversationHistory.push(newTurn);
            
            // Update Summary UI
            const totalAccumulatedContext = conversationHistory.reduce((sum, turn) => sum + turn.input + turn.output, 0);
            dom.summary.totalCost.textContent = `${formatKRW(totalCostKRW)} 원`;
            dom.summary.contextToken.textContent = formatNumber(totalAccumulatedContext);
            dom.summary.turnCount.textContent = formatNumber(conversationHistory.length);
            
            // Add to history log
            if (conversationHistory.length === 1) dom.summary.historyLog.innerHTML = "";
            const logEntry = document.createElement('p');
            const lorebookText = newTurn.usedLorebook ? ' <span class="text-purple-700 font-semibold">[+로어북]</span>' : '';
            logEntry.innerHTML = `<strong>Turn ${newTurn.turn}:</strong> In ${formatNumber(newTurn.input)} / Out ${formatNumber(newTurn.output)}${lorebookText}`;
            dom.summary.historyLog.appendChild(logEntry);
            dom.summary.historyLog.scrollTop = dom.summary.historyLog.scrollHeight;

            // Refresh preview for the next turn
            previewCost();
        }

        function resetConversation() {
            conversationHistory = [];
            totalCostKRW = 0;
            
            dom.contextLimitSelect.value = "0.8";
            dom.useLorebookCheckbox.checked = false;
            dom.inputSlider.value = 50;
            dom.outputSlider.value = 800;
            dom.inputSliderValue.textContent = formatNumber(50);
            dom.outputSliderValue.textContent = formatNumber(800);

            dom.summary.historyLog.innerHTML = "<p>아직 대화 기록이 없습니다.</p>";
            dom.summary.totalCost.textContent = `${formatKRW(0)} 원`;
            dom.summary.contextToken.textContent = formatNumber(0);
            dom.summary.turnCount.textContent = formatNumber(0);
            
            previewCost();
        }

        function applyScenario(scenario) {
            currentScenario = scenario;
            const preset = scenarioPresets[scenario];
            
            // Update UI elements
            dom.inputSlider.value = preset.input;
            dom.outputSlider.value = preset.output;
            dom.useLorebookCheckbox.checked = preset.lorebook;
            
            // Update display
            dom.inputSliderValue.textContent = formatNumber(preset.input);
            dom.outputSliderValue.textContent = formatNumber(preset.output);
            
            // Update scenario card selection
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-scenario="${scenario}"]`).classList.add('selected');
            
            previewCost();
        }

        // --- EVENT LISTENERS ---
        dom.addTurnBtn.addEventListener('click', handleAddTurn);
        dom.resetBtn.addEventListener('click', resetConversation);
        
        // Scenario selection
        document.querySelectorAll('.scenario-card').forEach(card => {
            card.addEventListener('click', () => {
                const scenario = card.dataset.scenario;
                applyScenario(scenario);
            });
        });
        
        // Listen for changes on select boxes and checkbox
        [
            dom.modelSelect, 
            dom.contextLimitSelect, 
            dom.useLorebookCheckbox,
            dom.dailyTurns,
            document.getElementById('user-count')
        ].forEach(el => {
            el.addEventListener('change', previewCost);
        });

        // System prompt token counting
        dom.systemPrompt.addEventListener('input', () => {
            const model = dom.modelSelect.value;
            const tokens = estimateTokensByModel(dom.systemPrompt.value, model);
            dom.systemTokenCount.textContent = formatNumber(tokens);
            previewCost();
        });

        // Listen for input on sliders for real-time updates
        dom.inputSlider.addEventListener('input', () => {
            dom.inputSliderValue.textContent = formatNumber(dom.inputSlider.value);
            previewCost();
        });

        dom.outputSlider.addEventListener('input', () => {
            dom.outputSliderValue.textContent = formatNumber(dom.outputSlider.value);
            previewCost();
        });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize system prompt token count
            const model = dom.modelSelect.value;
            const initialTokens = estimateTokensByModel(dom.systemPrompt.value, model);
            dom.systemTokenCount.textContent = formatNumber(initialTokens);
            
            // Apply default scenario
            applyScenario('casual');
            
            // Initial preview
            previewCost();
        });
    </script>
</body>
</html>
